<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Échiquier interactif</title>
  <style>
    body {
      background-color: #0b1a2b;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      font-family: Arial, sans-serif;
    }
    #chessboard {
      display: grid;
      grid-template-columns: repeat(8, 60px);
      grid-template-rows: repeat(8, 60px);
      margin-top: 50px;
      border: 4px solid white;
    }
    .square {
      width: 60px;
      height: 60px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 36px;
      cursor: pointer;
      user-select: none;
    }
    .white {
      background-color: #eee;
      color: black;
    }
    .black {
      background-color: #444;
    }
    .selected {
      outline: 3px solid yellow;
    }
    #status {
      margin-top: 20px;
      min-height: 20px;
    }
  </style>
</head>
<body>
  <h1>Échiquier</h1>
  <div id="chessboard"></div>
  <div id="status">Chargement...</div>

  <script>
    const boardDiv = document.getElementById('chessboard');
    const statusDiv = document.getElementById('status');

    let board = [];
    let turn = 'w';
    let selected = null; // {row, col}

    // Mapping des pièces backend -> symboles Unicode
    const pieceMap = {
      'wP': '♙', 'wR': '♖', 'wN': '♘', 'wB': '♗', 'wQ': '♕', 'wK': '♔',
      'bP': '♟', 'bR': '♜', 'bN': '♞', 'bB': '♝', 'bQ': '♛', 'bK': '♚',
      '': ''
    };

    function drawBoard() {
      boardDiv.innerHTML = '';
      for(let r=0; r<8; r++) {
        for(let c=0; c<8; c++) {
          const square = document.createElement('div');
          square.className = 'square ' + ((r+c)%2 === 0 ? 'white' : 'black');
          square.dataset.row = r;
          square.dataset.col = c;
          square.textContent = pieceMap[board[r][c] || ''] || '';
          if(selected && selected.row === r && selected.col === c) {
            square.classList.add('selected');
          }
          square.addEventListener('click', onSquareClick);
          boardDiv.appendChild(square);
        }
      }
      statusDiv.textContent = (turn === 'w' ? "Tour des Blancs" : "Tour des Noirs");
    }

    async function fetchBoard() {
      try {
        const res = await fetch('/board');
        if(!res.ok) throw new Error("Erreur de chargement du plateau");
        const data = await res.json();
        board = data.board;
        turn = data.turn;
        selected = null;
        drawBoard();
        statusDiv.textContent = (turn === 'w' ? "Tour des Blancs" : "Tour des Noirs");
      } catch(e) {
        statusDiv.textContent = "Erreur: " + e.message;
      }
    }

    async function playMove(fromRow, fromCol, toRow, toCol) {
      try {
        const res = await fetch('/move', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            from_row: fromRow,
            from_col: fromCol,
            to_row: toRow,
            to_col: toCol
          })
        });
        if(res.ok) {
          const data = await res.json();
          board = data.board;
          turn = data.turn;
          selected = null;
          drawBoard();
        } else {
          const err = await res.json();
          statusDiv.textContent = "Erreur: " + err.error;
          selected = null;
          drawBoard();
        }
      } catch(e) {
        statusDiv.textContent = "Erreur réseau";
      }
    }

    function onSquareClick(e) {
      const r = parseInt(e.currentTarget.dataset.row);
      const c = parseInt(e.currentTarget.dataset.col);
      const piece = board[r][c];

      if(selected) {
        // Tenter de jouer un coup
        if(r === selected.row && c === selected.col) {
          // Désélectionner la case
          selected = null;
          drawBoard();
          statusDiv.textContent = (turn === 'w' ? "Tour des Blancs" : "Tour des Noirs");
          return;
        }
        playMove(selected.row, selected.col, r, c);
      } else {
        // Sélectionner une pièce si c'est bien le tour
        if(piece && piece[0] === turn) {
          selected = {row: r, col: c};
          drawBoard();
          statusDiv.textContent = "Pièce sélectionnée en " + (r+1) + ", " + (c+1);
        }
      }
    }

    // Initialisation
    fetchBoard();

  </script>
</body>
</html>

  </script>
</body>
</html>

