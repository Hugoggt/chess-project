<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Échiquier interactif</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css" />
  <style>
    body {
      background-color: #001f3f; /* bleu nuit */
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      flex-direction: column;
      color: white;
      font-family: Arial, sans-serif;
    }
    #board {
      width: 480px;
    }
    #status {
      margin-top: 10px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div id="board"></div>
  <div id="status">Votre tour (blancs)</div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
  <script>
    let board = null;
    let game = new Chess();

    const statusEl = document.getElementById('status');

    // Initialiser l'échiquier
    function initBoard(fen) {
      if (board) board.destroy();

      board = Chessboard('board', {
        position: fen,
        draggable: true,
        orientation: 'white',
        onDrop: handleMove,
      });
    }

    // Charger l'état initial depuis backend
    async function loadBoard() {
      const resp = await fetch('/board');
      const data = await resp.json();
      game.load(data.fen);
      initBoard(data.fen);
      updateStatus(data);
    }

    function updateStatus(data) {
      if (data.is_game_over) {
        if (data.result === "1-0") statusEl.textContent = "Échec et mat ! Vous avez gagné.";
        else if (data.result === "0-1") statusEl.textContent = "Échec et mat ! L'IA a gagné.";
        else statusEl.textContent = "Partie terminée (nul).";
      } else {
        statusEl.textContent = "Votre tour (blancs)";
      }
    }

    // Quand le joueur déplace une pièce
    async function handleMove(source, target, piece, newPos, oldPos, orientation) {
      const move = source + target;
      const resp = await fetch('/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uci: move })
      });

      if (!resp.ok) {
        alert("Coup illégal ou erreur serveur");
        board.position(game.fen()); // reset la position
        return 'snapback';
      }

      const data = await resp.json();
      game.load(data.fen);
      board.position(data.fen);

      updateStatus(data);

      if (data.is_game_over) {
        alert("Partie terminée : " + data.result);
      }

      return;
    }

    loadBoard();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chess.js@1.0.0/chess.min.js"></script>
</body>
</html>

